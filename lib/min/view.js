'use strict';var _createClass=(function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if('value' in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}})();function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++){arr2[i]=arr[i]}return arr2}else {return Array.from(arr)}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError('Cannot call a class as a function')}}(function(){var Sand=window.Sand=window.Sand||{};var su=Sand.Utils;var bgRefresh=0.5;var sv=Sand.View=(function(){function _class(container){_classCallCheck(this,_class);this._container=container;this._width=this._container.clientWidth;this._height=this._container.clientHeight;this.setUp();this._clearColor=new su.Color(0,100,50,0.1);this._grainColor=new su.Color(0,100,100,1);this._center=new su.Vector(this._width/2,3*this._height/8);this.grain=new Sand.Grain({position:new (Function.prototype.bind.apply(su.Vector,[null].concat(_toConsumableArray(this._center.toArray())))),size:2,weight:1,color:this._grainColor});this._positiondelta=100}_createClass(_class,[{key:'setUp',value:function setUp(){var _this=this;this.cvs=document.createElement('canvas');this.cvs.setAttribute('width',this._width);this.cvs.setAttribute('height',3*this._height/4);this._container.appendChild(this.cvs);this.ctx=this.cvs.getContext('2d');this._bgColorPicker=new Sand.ColorPicker(this._width/2.1,this._height/4);this._container.appendChild(this._bgColorPicker.render().el());this._fgColorPicker=new Sand.ColorPicker(this._width/2.1,this._height/4);this._container.appendChild(this._fgColorPicker.render().el());var bgState={};this._bgColorPicker.el().addEventListener('colorchange',function(e){bgState['end']=true;var newColor=e.color;_this._clearColor.hue(newColor.hue());bgState=su.doUntil(true,function(_){_this._clearColor.saturation((_this._clearColor.saturation()+newColor.saturation()*2)/3);_this._clearColor.lightness((_this._clearColor.lightness()+newColor.lightness()*2)/3);_this._clearColor.alpha(bgRefresh);return Math.abs(_this._clearColor.saturation()-newColor.saturation())<1&&Math.abs(_this._clearColor.lightness()-newColor.lightness())<1})});var fgState={};this._fgColorPicker.el().addEventListener('colorchange',function(e){fgState['end']=true;var newColor=e.color;var newHue=newColor.hue();_this._grainColor.lightness(newColor.lightness());_this._grainColor.saturation(newColor.saturation());_this.grain.color=_this._grainColor;fgState=su.doUntil(true,function(_){_this._grainColor.rotate(Math.abs(_this._grainColor.hue()-newHue)/2*((_this._grainColor.hue()-newHue<0)-(_this._grainColor.hue()-newHue>0)));return Math.abs(_this._grainColor.hue()-newColor.hue())<=1})})}},{key:'start',value:function start(){var _this2=this;var mouseDown=false,trueCenter=this._center.dup(),trueWidth=this._width,minWidth=10,widthState={},posState={},counterAdvance=0.05;var downEvent=function downEvent(e){e.preventDefault();mouseDown=true;widthState['end']=true;posState['end']=true;_this2._clearColor.alpha(bgRefresh);_this2._clearColor=_this2._clearColor.invert();_this2.grain.color=_this2._grainColor=_this2._grainColor.invert();widthState=su.doUntil(minWidth,function(_){_this2._width=Math.floor((_this2._width*99+minWidth)/100);return _this2._width});var x=e.offsetX||e.targetTouches.item(0).clientX;posState=su.doUntil(true,function(){_this2._center.x=(_this2._center.x*10+x)/11;return Math.abs(_this2._center.x-x)<=1})};this.cvs.addEventListener('mousedown',downEvent);this.cvs.addEventListener('touchstart',downEvent);var upEvent=function upEvent(e){e.preventDefault();mouseDown=false;widthState['end']=true;posState['end']=true;_this2._clearColor.alpha(bgRefresh/5);_this2._clearColor=_this2._clearColor.invert();_this2.grain.color=_this2._grainColor=_this2._grainColor.invert();widthState=su.doUntil(Math.round(trueWidth),function(_){_this2._width=Math.ceil((_this2._width*20+trueWidth)/21);return _this2._width});posState=su.doUntil(trueCenter.x,function(){_this2._center.x=Math.floor((_this2._center.x*20+trueCenter.x)/21);return _this2._center.x})};this.cvs.addEventListener('mouseup',upEvent);this.cvs.addEventListener('touchend',upEvent);var moveEvent=function moveEvent(e){e.preventDefault();if(!mouseDown)return;posState['end']=true;var y=e.offsetY||e.targetTouches.item(0).clientY;_this2._positiondelta=trueCenter.distanceTo([trueCenter.x,y])/1;var x=e.offsetX||e.targetTouches.item(0).clientX;posState=su.doUntil(x,function(){_this2._center.x=Math.floor((_this2._center.x*10+x)/11);return _this2._center.x})};this.cvs.addEventListener('mousemove',moveEvent);this.cvs.addEventListener('touchmove',moveEvent);requestAnimationFrame(this.draw.bind(this));var counter=0,time=undefined,ctx=this.ctx;var sin=Math.sin,cos=Math.cos,PI=Math.PI;requestAnimationFrame(function updateTime(){time=new Date(Date.now());requestAnimationFrame(updateTime)});setInterval(function(){var gp=_this2._positiondelta;var num=time.getSeconds(),x=_this2._center.x,y=_this2._center.y;counter+=counterAdvance;counter*=counter<10000*PI;ctx.beginPath();ctx.moveTo(x,y);for(var i=-30;i<=30;i+=1+0*31/(num+1)){var turn=PI*i/120*counter+counter/10,sinI=sin(turn),cosI=cos(turn);_this2.grain.position.y=y+gp*sinI;for(var j=-2;j<=2;j++){var delY=20*j*sinI,delX=(_this2._width/num/30+minWidth)*i*cosI;_this2.grain.size=12.1+5*(cosI+sinI)+1*sin(_this2._height-gp*j/600+counter+i);_this2.grain.position.x=x+gp*cosI+_this2._width/2.25*cosI*cos(_this2._height-gp*i*j/600+counter+i);ctx.translate(delX,delY);_this2.grain.color.rotate(j*(i+30)/10);ctx.beginPath();_this2.grain.render(ctx);ctx.closePath();ctx.translate(-delX,-delY)}}},10)}},{key:'draw',value:function draw(){var ctx=this.ctx,cvs=ctx.canvas,gp=this._positiondelta;this.clear();requestAnimationFrame(this.draw.bind(this))}},{key:'clear',value:function clear(){var _this3=this;var opacity=arguments.length<=0||arguments[0]===undefined?0.01:arguments[0];var ctx=this.ctx,cvs=ctx.canvas;setTimeout(function(){ctx.fillStyle=''+_this3._clearColor;ctx.fillRect(0,0,cvs.width,cvs.height);var xDeg=Date.now()/7000%20-10;var yDeg=Date.now()/11000%20-10;ctx.drawImage(cvs,-xDeg/2,-yDeg/2,cvs.width+xDeg,cvs.height+yDeg)},0)}}]);return _class})()})();